type: sections
max_columns: 4
title: MC â›‘ï¸
path: meshcore_contacts
sections:
  - type: grid
    cards:
      - type: markdown
        content: |-
          ## Manage Contacts (Overview)
          {# 
          - read RTFM
          - change standard badges to your MC entities
          - change device ID in Reload Meshcore Device
          More info: https://github.com/WJ4IoT/Meshcore-Home-Assistant-Solutions

          Version: v1.03
          created & gathered together by WJ4IoT
          #}
        grid_options:
          columns: 12
          rows: auto
      - type: custom:badge-horizontal-container-card
        badges:
          - type: custom:mushroom-template-badge
            icon: mdi:home-assistant
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | list | count }}
            icon: mdi:account-group
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | selectattr('attributes.type', 'eq', 1) |      list |
              count }}
            icon: mdi:account
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor   | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.type', 'eq', 2) |list | count
              }}
            icon: mdi:radio-tower
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor   | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.type', 'eq', 3) |list | count
              }}
            icon: mdi:forum
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.adv_lat', 'ne', 0 )  | list |
              count }}
            icon: mdi:globe-model
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.flags', 'eq', 1 )  | list |
              count }}
            icon: mdi:flag
            color: blue
        badges_align: left
        badges_wrap: scroll
      - type: custom:badge-horizontal-container-card
        badges:
          - type: custom:mushroom-template-badge
            content: Status
            icon: mdi:home-assistant
            color: white
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | selectattr('state', 'eq', 'discovered') | list |
              count }} disc
            icon: mdi:account-group
            color: white
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | selectattr('state', 'eq', 'fresh') | list | count }}
              fresh
            icon: mdi:account-group
            color: green
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | selectattr('state', 'eq', 'stale') | list | count }}
              stale
            icon: mdi:account-group
            color: orange
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | selectattr('state', 'eq', 'unavailable') | list |
              count }} unavailable
            icon: mdi:account-group
            color: red
        badges_align: left
        badges_wrap: scroll
      - type: custom:badge-horizontal-container-card
        badges:
          - type: custom:mushroom-template-badge
            content: Inactive?
            icon: mdi:home-assistant
            color: red
          - type: custom:mushroom-template-badge
            content: >-
              {# set your own preferences #}  {% set now = now() | as_timestamp
              | int -%} {%- set time  = now - 3*24*60*60 -%}  {{
              states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') |  selectattr('attributes.lastmod','lt', time ) | list
              | count }} ?
            icon: mdi:account-group
            color: red
          - type: custom:mushroom-template-badge
            content: >-
              {# set your own preferences #}  {% set now = now() | as_timestamp
              | int -%} {%- set time  = now - 7*24*60*60 -%}  {{
              states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | selectattr('attributes.lastmod','lt', time ) |
              selectattr('attributes.type', 'eq', 1) |      list | count }}
            icon: mdi:account
            color: red
          - type: custom:mushroom-template-badge
            content: >-
              {# set your own preferences #}  {% set now = now() | as_timestamp
              | int -%} {%- set time  = now - 3*24*60*60 -%}  {{
              states.binary_sensor   | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.lastmod','lt', time ) |
              selectattr('attributes.type', 'eq', 2) |list | count }}
            icon: mdi:radio-tower
            color: red
          - type: custom:mushroom-template-badge
            content: >-
              {# set your own preferences #}  {% set now = now() | as_timestamp
              | int -%} {%- set time  = now - 3*24*60*60 -%}  {{
              states.binary_sensor | selectattr('attributes.lastmod', 'defined')
              | selectattr('attributes.lastmod','lt', time ) |
              selectattr('attributes.type', 'eq', 3) | list | count }}
            icon: mdi:forum
            color: red
        badges_align: left
        badges_wrap: scroll
      - type: custom:badge-horizontal-container-card
        badges:
          - type: custom:mushroom-template-badge
            icon: mdi:radio-handheld
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') | selectattr('attributes.added_to_node', 'true') | list
              | count }}
            icon: mdi:account-group
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined') |
                selectattr('attributes.added_to_node', 'true')| selectattr('attributes.type',
              'eq', 1) |      list | count }}
            icon: mdi:account
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor   | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.added_to_node', 'true') |
              selectattr('attributes.type', 'eq', 2) |list | count }}
            icon: mdi:radio-tower
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor   | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.added_to_node', 'true') |
              selectattr('attributes.type', 'eq', 3) |list | count }}
            icon: mdi:forum
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.added_to_node', 'true') |
              selectattr('attributes.adv_lat', 'ne', 0 )  | list | count }}
            icon: mdi:globe-model
            color: blue
          - type: custom:mushroom-template-badge
            content: >-
              {{ states.binary_sensor  | selectattr('attributes.lastmod',
              'defined')  | selectattr('attributes.added_to_node', 'true') |
              selectattr('attributes.flags', 'eq', 1 )  | list | count }}
            icon: mdi:flag
            color: blue
        badges_align: left
        badges_wrap: scroll
      - type: entities
        title: Manage Contacts (BULK)
        entities:
          - type: button
            name: ðŸ”„ Reload Meshcore Device
            action_name: Releoad
            tap_action:
              action: call-service
              service: homeassistant.reload_config_entry
              data:
                device_id: 384066b87fc8947db720c5e54ae6ed14
          - type: button
            name: ðŸ§¹ Cleanup Unavailable Contacts
            action_name: Cleanup
            tap_action:
              action: call-service
              service: meshcore.cleanup_unavailable_contacts
          - type: button
            name: âš ï¸ Remove Obsolete Discovered Companions
            action_name: Companions
            tap_action:
              action: call-service
              service: script.meshcore_contact_management
              data:
                option: companions
                days: 7.5
          - type: button
            name: âš ï¸ Remove Obsolete Discovered Repeaters
            action_name: Repeaters
            tap_action:
              action: call-service
              service: script.meshcore_contact_management
              data:
                option: repeaters
                days: 3.5
          - type: button
            name: âš ï¸ Remove Added Contacts from Discovered File
            action_name: Added
            tap_action:
              action: call-service
              service: script.meshcore_contact_management
              data:
                option: added
          - type: button
            name: ðŸ›‘ Remove Old Contacts From Node
            action_name: Old
            tap_action:
              action: call-service
              service: script.meshcore_contact_management
              data:
                option: old_node_contacts
                days: 14
        grid_options:
          columns: 12
          rows: auto
  - type: grid
    cards:
      - type: entities
        title: Manage Contacts (Individual)
        entities:
          - entity: select.meshcore_discovered_contact
            name: Discovered
            secondary_info: last-changed
          - type: button
            name: âž• Add Contact
            action_name: Add
            tap_action:
              action: call-service
              service: meshcore.add_selected_contact
          - type: button
            name: ðŸ—‘ï¸ Remove Discovered
            action_name: Remove
            tap_action:
              action: call-service
              service: meshcore.remove_discovered_contact
          - entity: select.meshcore_added_contact
            name: Added
            secondary_info: last-changed
          - type: button
            name: âž– Remove Contact
            action_name: Remove
            tap_action:
              action: call-service
              service: meshcore.remove_selected_contact
          - type: button
            name: ðŸš© Toggle Favorite Flag (slow response)
            action_name: Toggle
            tap_action:
              action: call-service
              service: script.meshcore_contact_management
              data:
                option: favorite
      - type: vertical-stack
        cards:
          - type: markdown
            content: >-
              {%- if states('select.meshcore_added_contact') != "Select a
              contact..." %}  {% set contact =
              states('select.meshcore_added_contact') %} {% else %} {% set
              contact = states('select.meshcore_discovered_contact') %} {% endif
              %}  {% set public_key = contact[-13:-1] %} {% set DEVICES =
              states.binary_sensor
                | selectattr('attributes.lastmod', 'defined')
                | selectattr('entity_id', 'search', public_key)
                | map(attribute='entity_id')
                | list  
              %} {% for id in DEVICES %} {{ states[id].name }} ({{ public_key
              }}) {% if states[id].attributes.flags == 1 %} - favorite {% endif
              %}

              Added to Node : {{ states[id].attributes.added_to_node }} ({{
              states[id].state }})

              Last Advert : {{ states[id].attributes.last_advert |
              timestamp_custom('%Y-%m-%d %H:%M')}} 

              Last Mod : {{ states[id].attributes.lastmod | int
              |timestamp_custom('%Y-%m-%d %H:%M')}} 

              {# removed next section if not using #} Afstand: {%- set lat =
              states[id].attributes.adv_lat -%} {%- set lon =
              states[id].attributes.adv_lon -%} {%- from 'bearing.jinja' import
              calc_bearing -%} {{- calc_bearing( lat, lon, 'T') -}}      {#- end
              section -#}

              {# removed below section if not using #} {%- set hops =
              'sensor.meshcore_advert_'~public_key -%} 

              {%- if states[hops].state is defined %} {%- if
              states[hops].attributes.interval is defined %}  Advert Details:
              Hops: {{states[hops].attributes.hops}} Path:
              {{states[hops].attributes.path}} Interval:
              {{states[hops].attributes.interval}} min  {% endif %} {% endif %}
              {# end section #}

              {%- endfor -%}
        grid_options:
          columns: 12
          rows: auto
        visibility:
          - condition: state
            state_not: ""
cards: []
badges:
  - type: entity
    entity: sensor.meshcore_ab389b_node_status_wj_serial
    show_name: false
  - type: entity
    entity: sensor.meshcore_ab389b_battery_percentage_wj_serial
    name: Battery
  - type: entity
    entity: sensor.meshcore_ab389b_battery_voltage_wj_serial
    name: Volts
  - type: entity
    entity: sensor.meshcore_ab389b_frequency_wj_serial
    name: Freq
  - type: entity
    entity: sensor.meshcore_ab389b_tx_power_wj_serial
    name: TX
    icon: mdi:antenna
  - type: entity
    entity: sensor.meshcore_ab389b_spreading_factor_wj_serial
    name: SF
    icon: mdi:video-input-antenna
  - type: entity
    show_name: false
    show_state: true
    show_icon: true
    entity: sensor.meshcore_ab389b_node_count_wj_serial
    name: Nodes
