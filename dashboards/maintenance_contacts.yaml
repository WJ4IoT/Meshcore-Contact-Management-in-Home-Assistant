type: sections
max_columns: 4
title: MC Maintenance
path: mc-maintenance
sections:
  - type: grid
    cards:
      - type: markdown
        title: Overview
        content: >-
          {% set contains = states['input_text.meshcore_contact'].state %}

          {% set type = states['input_select.meshcore_contact_type'].state[:1]
          |  int(1) %} 

          {%- set days = states['input_number.meshcore_days_old'].state | 
          int(0) %} {% set now = now() | as_timestamp | int %}  {%- set time =
          now - days*24*60*60 %} 


          Total: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | list
            | count 
            }} Contacts (fav: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.flags', 'eq', 1)
            | list
            | count 
            }}) (on node: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.added_to_node', 'true')
            | list
            | count }} - inactive?: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.added_to_node', 'true')
            | selectattr('attributes.lastmod','lt', time )
            | list
            | count }})
            
          {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq', 1 )
            | list
            | count 
            }} Companions (fav: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.flags', 'eq', 1)
            | selectattr('attributes.type', 'eq', 1 )
            | list
            | count  
            }}) (on node: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq', 1 )
            | selectattr('attributes.added_to_node', 'true')
            | list
            | count }} - inactive?: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq',1 )
            | selectattr('attributes.added_to_node', 'true')
            | selectattr('attributes.lastmod','lt', time )
            | list
            | count }})
          {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq', 2 )
            | list
            | count }} Repeaters (fav: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.flags', 'eq', 1)
            | selectattr('attributes.type', 'eq', 2 )
            | list
            | count  
            }}) (on node: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq', 2 )
            | selectattr('attributes.added_to_node', 'true')
            | list
            | count }}- inactive?: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq',2)
            | selectattr('attributes.added_to_node', 'true')
            | selectattr('attributes.lastmod','lt', time )
            | list
            | count }})
          {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq', 3 )
            | list
            | count  
            }} Room Servers (fav: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.flags', 'eq', 1)
            | selectattr('attributes.type', 'eq', 3 )
            | list
            | count  
            }}) (on node: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq',3 )
            | selectattr('attributes.added_to_node', 'true')
            | list
            | count }} - inactive?: {{ states.binary_sensor
            | selectattr('attributes.last_advert', 'defined')
            | selectattr('attributes.type', 'eq',3 )
            | selectattr('attributes.added_to_node', 'true')
            | selectattr('attributes.lastmod','lt', time )
            | list
            | count }})
        grid_options:
          columns: 12
          rows: auto
      - type: custom:mushroom-select-card
        entity: input_select.meshcore_maintenance_focus
        grid_options:
          columns: 12
          rows: 2
      - type: horizontal-stack
        cards:
          - type: custom:mushroom-select-card
            entity: input_select.meshcore_contact_type
          - type: custom:mushroom-number-card
            entity: input_number.meshcore_days_old
            display_mode: buttons
        title: Reduce Selection
      - type: horizontal-stack
        cards:
          - type: entities
            entities:
              - entity: input_text.meshcore_contact_search
        grid_options:
          columns: 12
          rows: 1.5
  - type: grid
    cards:
      - type: vertical-stack
        cards:
          - type: entities
            entities:
              - entity: input_select.meshcore_selection
            title: Select Contact
          - type: markdown
            content: >-
              {%- set id = states('input_select.meshcore_selection') -%}

              {%- if id == "No Selection" -%}

              No Selection, reduce selection filters

              {%- elif states[id].name is not defined -%}

              Bye, Bye

              {%- else -%}

              {%- set mac = id[-20:-8] -%}  

              {{ states[id].name }} ({{mac}}

              {%- if states[id].attributes.flags is defined -%} 

              {%- if states[id].attributes.flags == 1 %} - favorite {%- endif
              -%}{%- endif -%})

              {% if states[id].attributes.last_advert is not defined -%}

              (no details availlable due to removal){%- else -%}

              Last Advert: {{states[id].attributes.last_advert |
              timestamp_custom('%Y-%m-%d %H:%M')}} ({{ states[id].state }})

              Last Mod: {{states[id].attributes.lastmod | int
              |timestamp_custom('%Y-%m-%d %H:%M')}}

              Distance: {{ distance(states[id].attributes.adv_lat,
              states[id].attributes.adv_lon) | round(2) }} km 

              {%- endif -%}

              {%- set mac12 = 'sensor.meshcore_'~mac~'_hops' -%} 

              {%- if states[mac12].state is defined %} 

              Hops: {{states[mac12].attributes.hops}} Path:
              {{states[mac12].attributes.path}} Interval:
              {{states[mac12].attributes.interval}} uur 

              {% endif %} {% endif %}
          - type: markdown
            content: >-
              {%- set id = states('input_select.meshcore_selection') -%} {%- if
              id != "No Selection" -%}

              {%- if states[id].adv_lat is not defined -%}
              {%- else -%}

              {%- set lat = states[id].attributes.adv_lat -%} 
              {%- set lon = states[id].attributes.adv_lon -%} 
              {%- set current_lat = state_attr('zone.home', 'latitude') | float -%} 
              {%- set current_lon =  state_attr('zone.home', 'longitude') | float -%}
              {%- set target_lat =  lat | float -%} 
              {%- set target_lon =  lon | float -%} 
              {%- set rad = 0.017453292519943295 -%} 
              {%- set current_lat_rad= (current_lat * rad) | float -%} 
              {%- set current_lon_rad= (current_lon * rad) | float -%} {%- set
              target_lat_rad= (target_lat * rad) | float -%} {%- set
              target_lon_rad= (target_lon * rad) | float -%} {%- set delta_lat =
              (target_lat_rad - current_lat_rad) | float -%} {%- set delta_lon=
              (target_lon_rad - current_lon_rad) | float -%} {%- set
              half_delta_lat = (delta_lat / 2.0) | float -%} {%- set
              half_delta_lon = (delta_lon / 2.0) | float -%} {%- set
              sin_half_delta_lat = half_delta_lat | float | sin -%} {%- set
              sin_half_delta_lon = half_delta_lon | float | sin  -%} {%- set a =
              ((sin_half_delta_lat ** 2) + (cos(current_lat_rad) *
                  cos(target_lat_rad) * (sin_half_delta_lon ** 2))) | float -%}
              {%- set c = (2.0 * atan2(sqrt(a), sqrt(1.0 - a))) | float -%} {%-
              set dist = (c) * 6371.0 | round(1) -%} {%- set y = (sin(delta_lon)
              | float) * (cos(target_lat_rad) | float) -%} {%- set x = (
              (cos(current_lat_rad) | float) * (sin(target_lat_rad) | float) -
              (sin(current_lat_rad) | float) * (cos(target_lat_rad) | float) *
                            (cos(delta_lon) | float)) | float -%}
              {% set bearing = ((atan2(y, x) * 57.2957795) + 360.0) % 360.0 |
              round(1)      %} Distance:  {{ dist | round(2) }} km, bearing: {%-
              if bearing <= 22.5 %} N {%- elif bearing <= 67.5 %} NE  {%- elif
              bearing <= 112.5 %} E  {%- elif bearing <= 157.5 %} SE  {%- elif
              bearing <= 202.5 %} S  {%- elif bearing <= 247.5 %} SW {%- elif
              bearing <= 292.5 %} W {%- elif bearing <= 337.5 %} NW {%- else
              -%}  N  {%- endif %} {{ bearing | round(1)}}Â° {%- endif -%} {%-
              endif -%}
          - type: conditional
            conditions:
              - condition: state
                entity: input_select.meshcore_maintenance_focus
                state: ADD DISCOVERED
            card:
              type: button
              name: Add Discovered Contact
              icon: mdi:plus-circle
              tap_action:
                action: perform-action
                perform_action: automation.trigger
                target:
                  entity_id: automation.meshcore_maintenance_do_action
                data:
                  skip_condition: true
          - type: conditional
            conditions:
              - condition: state
                entity: input_select.meshcore_maintenance_focus
                state: REMOVE CONTACT
            card:
              type: button
              name: Remove Contact
              icon: mdi:minus-circle
              tap_action:
                action: perform-action
                perform_action: automation.trigger
                target:
                  entity_id: automation.meshcore_maintenance_do_action
                data:
                  skip_condition: true
          - type: conditional
            conditions:
              - condition: state
                entity: input_select.meshcore_maintenance_focus
                state: REMOVE DISCOVERED
            card:
              show_name: true
              show_icon: true
              type: button
              name: Remove Discovered
              icon: mdi:cloud-question
              tap_action:
                action: perform-action
                perform_action: automation.trigger
                target:
                  entity_id: automation.meshcore_maintenance_do_action
                data:
                  skip_condition: true
          - type: conditional
            conditions:
              - condition: state
                entity: input_select.meshcore_maintenance_focus
                state: TOGGLE FAVORITE
            card:
              show_name: true
              show_icon: true
              type: button
              name: Toggle Favorite
              icon: mdi:flag-variant
              tap_action:
                action: perform-action
                perform_action: automation.trigger
                target:
                  entity_id: automation.meshcore_maintenance_do_action
                data:
                  skip_condition: true
      - show_name: true
        show_icon: true
        type: button
        name: Cleanup Unavailable Contacts
        icon: mdi:broom
        tap_action:
          action: call-service
          service: meshcore.cleanup_unavailable_contacts
        grid_options:
          columns: 12
          rows: 2
visible: []
cards: []
