alias: Meshcore - Maintenance Selection
description: Updates field based upon the selection criteria
triggers:
  - trigger: state
    entity_id:
      - input_select.meshcore_maintenance_focus
      - input_number.meshcore_days_old
      - input_select.meshcore_contact_type
      - input_text.meshcore_contact_search
conditions: []
actions:
  - variables:
      type: "{{ states['input_select.meshcore_contact_type'].state[:1] | int }}"
      days_old: "{{ states['input_number.meshcore_days_old'].state | int }}"
      time: "{{ ( now() | as_timestamp | int ) - days_old*60*60*24  }}"
      contains: "{{ states['input_text.meshcore_contact_search'].state | lower }}"
  - action: input_select.set_options
    metadata: {}
    data:
      options:
        - No Selection
    target:
      entity_id: input_select.meshcore_selection
  - choose:
      - conditions:
          - condition: state
            entity_id: input_select.meshcore_maintenance_focus
            state: ADD DISCOVERED
        sequence:
          - action: input_select.set_options
            data:
              options: |
                {{ states.binary_sensor
                | selectattr('attributes.last_advert', 'defined')
                | selectattr('state', 'eq', 'discovered')
                | selectattr('attributes.type', 'eq', type )
                | selectattr('attributes.lastmod', 'ge', time )
                | selectattr('entity_id', 'search', contains)
                | map(attribute='entity_id')
                | list
                }}
            target:
              entity_id: input_select.meshcore_selection
      - conditions:
          - condition: state
            entity_id: input_select.meshcore_maintenance_focus
            state: REMOVE CONTACT
        sequence:
          - action: input_select.set_options
            data:
              options: |
                {{ states.binary_sensor
                | selectattr('attributes.lastmod', 'defined')
                | selectattr('state', 'ne', 'discovered') 
                | selectattr('attributes.added_to_node', 'eq', true )  
                | selectattr('attributes.type', 'eq', type )
                | selectattr('attributes.lastmod', 'le', time )
                | selectattr('entity_id', 'search', contains)
                | map(attribute='entity_id')
                | list
                }}
            target:
              entity_id: input_select.meshcore_selection
      - conditions:
          - condition: state
            entity_id: input_select.meshcore_maintenance_focus
            state: REMOVE DISCOVERED
        sequence:
          - action: input_select.set_options
            data:
              options: |
                {{ states.binary_sensor
                | selectattr('attributes.lastmod', 'defined')
                | selectattr('state', 'eq', 'discovered') 
                | selectattr('attributes.type', 'eq', type )
                | selectattr('attributes.lastmod', 'le', time )
                | selectattr('entity_id', 'search', contains)
                | map(attribute='entity_id')
                | list  
                }}
            target:
              entity_id: input_select.meshcore_selection
      - conditions:
          - condition: state
            entity_id: input_select.meshcore_maintenance_focus
            state: TOGGLE FAVORITE
        sequence:
          - action: input_select.set_options
            data:
              options: |
                {{ states.binary_sensor
                | selectattr('attributes.lastmod', 'defined')
                | selectattr('state', 'ne', 'discovered') 
                | selectattr('attributes.added_to_node', 'eq', true )   
                | selectattr('attributes.type', 'eq', type )
                | selectattr('entity_id', 'search', contains)
                | map(attribute='entity_id')
                | list  
                }}
            target:
              entity_id: input_select.meshcore_selection
mode: single
