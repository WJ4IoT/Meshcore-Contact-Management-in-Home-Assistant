alias: Meshcore - Contact Management
description: Mostly used for BULK removal of contacts
sequence:
  - choose:
      - conditions:
          - condition: template
            value_template: "{{ option == 'favorite' }}"
        sequence:
          - variables:
              pubkey_prefix: >-
                {{- state_attr('select.meshcore_added_contact','pubkey_prefix')
                -}}
          - repeat:
              for_each: >-
                {{ states.binary_sensor |  selectattr('attributes.lastmod',
                'defined') | selectattr('attributes.pubkey_prefix', 'contains',
                pubkey_prefix) | map(attribute='object_id') | list }}
              sequence:
                - variables:
                    entity_id: binary_sensor.{{ repeat.item }}
                    favorite: "{{ state_attr(entity_id,'flags')}}"
                    toggle: |-
                      {% if favorite == 0 %}
                        1
                      {% else %}
                        0
                      {% endif %}
                - action: meshcore.execute_command
                  data:
                    command: change_contact_flags {{ pubkey_prefix }} {{ toggle }}
      - conditions:
          - condition: template
            value_template: "{{ option == 'old_node_contacts' }}"
        sequence:
          - variables:
              days_old: |-
                {% if days < 7 %}
                  7
                {% else %}
                  {{ days }}
                {% endif %}
          - repeat:
              for_each: |-
                {%- set time = now() | as_timestamp | int -%} 
                {%- set time = time - days_old*24*60*60 -%}  
                {{- states.binary_sensor  
                | selectattr('attributes.lastmod', 'defined') 
                | selectattr('state', 'eq', 'stale')  
                | selectattr('attributes.lastmod', 'lt', time ) 
                | map(attribute='object_id') | list }}
              sequence:
                - variables:
                    public_key: "{{ repeat.item[-20:-8] }}"
                - action: meshcore.execute_command
                  data:
                    command: remove_contact {{ public_key }}
                  enabled: false
      - conditions:
          - condition: template
            value_template: "{{ option == 'companions' }}"
        sequence:
          - variables:
              days_old: |-
                {% if days < 7 %}
                  7
                {% else %}
                  {{ days }}
                {% endif %}
          - repeat:
              for_each: |-
                {%- set time = now() | as_timestamp | int -%} 
                {%- set time = time - days_old*24*60*60 -%}  
                {{- states.binary_sensor  | 
                selectattr('attributes.lastmod', 'defined') | 
                selectattr('state', 'eq', 'discovered')  |
                selectattr('attributes.lastmod', 'lt', time ) |
                selectattr('attributes.type', 'eq', 1 )  |
                map(attribute='object_id') | list -}}
              sequence:
                - variables:
                    public_key: "{{ repeat.item[-20:-8] }}"
                - action: meshcore.remove_discovered_contact
                  data:
                    pubkey_prefix: "{{ public_key }}"
                  enabled: false
      - conditions:
          - condition: template
            value_template: "{{ option == 'repeaters' }}"
        sequence:
          - variables:
              days_old: |-
                {% if days < 3 %}
                  3
                {% else %}
                  {{ days }}
                {% endif %}
          - repeat:
              for_each: |-
                {%- set time = now() | as_timestamp | int -%}
                {%- set time = time - days_old*24*60*60 -%}
                {{- states.binary_sensor  
                | selectattr('attributes.lastmod', 'defined') 
                | selectattr('state', 'eq', 'discovered')  
                | selectattr('attributes.type', 'ne', 1 )
                | selectattr('attributes.lastmod', 'lt', time )  
                | map(attribute='object_id') | list }}
              sequence:
                - variables:
                    public_key: "{{ repeat.item[-20:-8] }}"
                - action: meshcore.remove_discovered_contact
                  data:
                    pubkey_prefix: "{{ public_key }}"
                  enabled: false
      - conditions:
          - condition: template
            value_template: "{{ option == 'added' }}"
        sequence:
          - repeat:
              for_each: |-
                {{- states.binary_sensor  
                | selectattr('attributes.lastmod','defined') 
                | selectattr('state', 'ne', 'discovered')  
                | selectattr('attributes.added_to_node', 'eq', true )  
                | map(attribute='object_id') | list -}}
              sequence:
                - variables:
                    public_key: "{{ repeat.item[-20:-8] }}"
                - action: meshcore.remove_discovered_contact
                  data:
                    pubkey_prefix: "{{ public_key }}"
          - action: script.meshcore_contact_management
            metadata: {}
            data:
              option: reload
            enabled: false
    default:
      - stop: Created by WJ4IoT v1.02 Reduced bulk action to core actions.
        enabled: false
fields:
  option:
    selector:
      text: null
    name: option
    description: input files which defines the sequence
    required: true
  days:
    selector:
      number:
        min: 0.5
        max: 100
    name: days
    description: Number of days the contact must be old
    required: false
